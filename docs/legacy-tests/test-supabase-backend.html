<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 TEST BACKEND SUPABASE - Mental Commons v3.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .phase {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .phase h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .test-button.error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        .result {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .success { border-color: #28a745; }
        .error { border-color: #dc3545; }
        .warning { border-color: #ffc107; }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status.pending { background: #fff3cd; color: #856404; }
        .status.running { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .credentials {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .device-info {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .score {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score.excellent { color: #28a745; }
        .score.good { color: #20c997; }
        .score.fair { color: #ffc107; }
        .score.poor { color: #dc3545; }
        
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8rem; }
            .test-button { padding: 10px 20px; margin: 3px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 TEST BACKEND SUPABASE v3.0</h1>
        
        <div class="info-box">
            <h3>🎯 Obiettivo Test</h3>
            <p>Verificare il funzionamento completo del backend Supabase con autenticazione JWT, registrazione utenti e salvataggio UCMe cross-device.</p>
            <p><strong>Backend URL:</strong> <span id="backend-url">Rilevamento automatico...</span></p>
        </div>
        
        <div class="credentials">
            <h3>🔑 Credenziali di Test Pre-configurate</h3>
            <p><strong>Account test esistente:</strong></p>
            <p>📧 Email: <code>test@mentalcommons.it</code></p>
            <p>🔑 Password: <code>test123</code></p>
            <p><em>Questo account dovrebbe essere pre-configurato nel database Supabase</em></p>
        </div>
        
        <div class="device-info" id="device-info">
            📱 Caricamento info dispositivo...
        </div>
        
        <!-- FASE 1: TEST REGISTRAZIONE -->
        <div class="phase">
            <h2>🟣 FASE 1 — TEST REGISTRAZIONE <span id="phase1-status" class="status pending">PENDING</span></h2>
            <p>Test creazione nuovo account con backend Supabase persistente</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div>
                    <label>📧 Email:</label>
                    <input type="email" id="register-email" placeholder="nuovo@test.it">
                </div>
                <div>
                    <label>👤 Nome:</label>
                    <input type="text" id="register-name" placeholder="Il tuo nome">
                </div>
            </div>
            <div>
                <label>🔑 Password:</label>
                <input type="password" id="register-password" placeholder="Minimo 6 caratteri">
            </div>
            
            <button class="test-button" onclick="testRegistration()">📝 Test Registrazione</button>
            <button class="test-button" onclick="generateRandomUser()">🎲 Genera Utente Random</button>
            <div id="phase1-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- FASE 2: TEST LOGIN -->
        <div class="phase">
            <h2>🟣 FASE 2 — TEST LOGIN <span id="phase2-status" class="status pending">PENDING</span></h2>
            <p>Test autenticazione con database Supabase e generazione JWT tokens</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div>
                    <label>📧 Email:</label>
                    <input type="email" id="login-email" value="test@mentalcommons.it">
                </div>
                <div>
                    <label>🔑 Password:</label>
                    <input type="password" id="login-password" value="test123">
                </div>
            </div>
            
            <button class="test-button" onclick="testLogin()">🔑 Test Login</button>
            <button class="test-button" onclick="testLoginNewUser()">👤 Login Utente Appena Creato</button>
            <button class="test-button" onclick="testLoginInvalid()">❌ Test Credenziali Sbagliate</button>
            <div id="phase2-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- FASE 3: TEST UCME -->
        <div class="phase">
            <h2>🟣 FASE 3 — TEST UCME <span id="phase3-status" class="status pending">PENDING</span></h2>
            <p>Test salvataggio UCMe su database PostgreSQL con autenticazione JWT</p>
            
            <div>
                <label>📋 Titolo UCMe (opzionale):</label>
                <input type="text" id="ucme-title" placeholder="Titolo della tua riflessione">
            </div>
            <div>
                <label>📝 Contenuto UCMe:</label>
                <textarea id="ucme-content" rows="4" placeholder="Scrivi qui il tuo pensiero... (min 20, max 600 caratteri)">Questo è un pensiero di test per verificare il salvataggio persistente delle UCMe nel backend Supabase v3.0. Il sistema deve salvare in PostgreSQL e garantire sincronizzazione cross-device tramite JWT tokens.</textarea>
            </div>
            
            <button class="test-button" onclick="testSaveUCMe()">💾 Salva UCMe</button>
            <button class="test-button" onclick="testLoadUCMes()">📥 Carica UCMe Utente</button>
            <button class="test-button" onclick="testSaveWithoutAuth()">🚫 Test Senza Auth</button>
            <div id="phase3-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- FASE 4: TEST CROSS-DEVICE -->
        <div class="phase">
            <h2>🟣 FASE 4 — TEST CROSS-DEVICE & JWT <span id="phase4-status" class="status pending">PENDING</span></h2>
            <p>Verifica persistenza login e dati tra dispositivi diversi</p>
            
            <button class="test-button" onclick="testJWTValidation()">🎫 Test Validazione JWT</button>
            <button class="test-button" onclick="testTokenPersistence()">💾 Test Persistenza Token</button>
            <button class="test-button" onclick="testCrossDevice()">🔄 Test Cross-Device Complete</button>
            <button class="test-button" onclick="clearAllData()">🗑️ Pulisci Dati Locali</button>
            <div id="phase4-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- FASE 5: TEST AUTOMATICO COMPLETO -->
        <div class="phase">
            <h2>🟣 FASE 5 — RUN ALL TESTS <span id="phase5-status" class="status pending">PENDING</span></h2>
            <p>Eseguire tutti i test in sequenza automatica per validazione completa</p>
            
            <button class="test-button" onclick="runAllTests()" style="font-size: 1.1rem; padding: 15px 30px;">🚀 ESEGUI TUTTI I TEST</button>
            <div id="phase5-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- SUMMARY -->
        <div class="summary" id="test-summary" style="display: none;">
            <h2>📊 RISULTATO FINALE</h2>
            <div class="score" id="final-score">---%</div>
            <div id="summary-details"></div>
        </div>
    </div>

    <script>
        // Variabili globali
        let currentToken = null;
        let currentUser = null;
        let testResults = {
            registration: [],
            login: [],
            ucme: [],
            crossDevice: [],
            jwt: []
        };
        
        // Rilevamento automatico URL backend
        const API_BASE = window.location.origin;
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            updateDeviceInfo();
            loadStoredToken();
            document.getElementById('backend-url').textContent = API_BASE;
        });
        
        // ================================================================
        // UTILITÀ
        // ================================================================
        
        function updateDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                localStorageAvailable: typeof(Storage) !== "undefined",
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('device-info').innerHTML = `
                📱 <strong>Device Info:</strong><br>
                🖥️ Platform: ${info.platform}<br>
                🌐 User Agent: ${info.userAgent.substring(0, 60)}...<br>
                📐 Viewport: ${info.viewport}<br>
                🍪 Cookies: ${info.cookieEnabled}<br>
                💾 LocalStorage: ${info.localStorageAvailable}<br>
                🌐 Online: ${info.onLine}<br>
                ⏰ ${info.timestamp}
            `;
        }
        
        function loadStoredToken() {
            currentToken = localStorage.getItem('mental_commons_token');
            currentUser = JSON.parse(localStorage.getItem('mental_commons_user') || 'null');
            
            if (currentToken && currentUser) {
                log('🎫 Token trovato in localStorage per utente: ' + currentUser.email);
            } else {
                log('❌ Nessun token trovato in localStorage');
            }
        }
        
        function saveTokenAndUser(token, user) {
            currentToken = token;
            currentUser = user;
            localStorage.setItem('mental_commons_token', token);
            localStorage.setItem('mental_commons_user', JSON.stringify(user));
            log('💾 Token e utente salvati in localStorage');
        }
        
        function clearStoredData() {
            currentToken = null;
            currentUser = null;
            localStorage.removeItem('mental_commons_token');
            localStorage.removeItem('mental_commons_user');
            log('🗑️ Dati locali puliti');
        }
        
        function log(message, elementId = null) {
            const timestamp = new Date().toISOString().substring(11, 23);
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'block';
                    element.textContent += logMessage + '\n';
                    element.scrollTop = element.scrollHeight;
                }
            }
        }
        
        function updateStatus(phaseId, status) {
            const statusElement = document.getElementById(phaseId + '-status');
            if (statusElement) {
                statusElement.className = `status ${status}`;
                statusElement.textContent = status.toUpperCase();
            }
        }
        
        function generateRandomUser() {
            const randomId = Math.floor(Math.random() * 10000);
            document.getElementById('register-email').value = `user${randomId}@test.it`;
            document.getElementById('register-name').value = `Test User ${randomId}`;
            document.getElementById('register-password').value = 'password123';
            log('🎲 Utente random generato');
        }
        
        // ================================================================
        // TEST REGISTRAZIONE
        // ================================================================
        
        async function testRegistration() {
            updateStatus('phase1', 'running');
            log('📝 INIZIO TEST REGISTRAZIONE', 'phase1-result');
            
            const email = document.getElementById('register-email').value;
            const name = document.getElementById('register-name').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !name || !password) {
                log('❌ Compila tutti i campi per la registrazione', 'phase1-result');
                updateStatus('phase1', 'error');
                return false;
            }
            
            try {
                log(`📤 Invio richiesta registrazione per: ${email}`, 'phase1-result');
                log(`📤 URL: ${API_BASE}/api/register`, 'phase1-result');
                
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        name: name
                    })
                });
                
                const data = await response.json();
                
                log(`📥 Risposta ricevuta (${response.status}):`, 'phase1-result');
                log(JSON.stringify(data, null, 2), 'phase1-result');
                
                if (data.success) {
                    log('✅ REGISTRAZIONE RIUSCITA!', 'phase1-result');
                    
                    // Salva token per login automatico
                    if (data.token && data.user) {
                        saveTokenAndUser(data.token, data.user);
                        log('🎫 Token salvato per login automatico', 'phase1-result');
                        
                        // Aggiorna campi login
                        document.getElementById('login-email').value = email;
                        document.getElementById('login-password').value = password;
                    }
                    
                    updateStatus('phase1', 'success');
                    testResults.registration.push({
                        timestamp: new Date().toISOString(),
                        email: email,
                        success: true,
                        response: data
                    });
                    return true;
                } else {
                    log('❌ REGISTRAZIONE FALLITA: ' + data.message, 'phase1-result');
                    updateStatus('phase1', 'error');
                    testResults.registration.push({
                        timestamp: new Date().toISOString(),
                        email: email,
                        success: false,
                        error: data.message
                    });
                    return false;
                }
                
            } catch (error) {
                log('💥 ERRORE REGISTRAZIONE: ' + error.message, 'phase1-result');
                updateStatus('phase1', 'error');
                testResults.registration.push({
                    timestamp: new Date().toISOString(),
                    email: email,
                    success: false,
                    error: error.message
                });
                return false;
            }
        }
        
        // ================================================================
        // TEST LOGIN
        // ================================================================
        
        async function testLogin() {
            updateStatus('phase2', 'running');
            log('🔑 INIZIO TEST LOGIN', 'phase2-result');
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                log('❌ Inserisci email e password', 'phase2-result');
                updateStatus('phase2', 'error');
                return false;
            }
            
            try {
                log(`📤 Invio richiesta login per: ${email}`, 'phase2-result');
                log(`📤 URL: ${API_BASE}/api/login`, 'phase2-result');
                
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                log(`📥 Risposta ricevuta (${response.status}):`, 'phase2-result');
                log(JSON.stringify(data, null, 2), 'phase2-result');
                
                if (data.success) {
                    log('✅ LOGIN RIUSCITO!', 'phase2-result');
                    
                    if (data.token && data.user) {
                        saveTokenAndUser(data.token, data.user);
                        log('🎫 Token JWT salvato', 'phase2-result');
                    }
                    
                    updateStatus('phase2', 'success');
                    testResults.login.push({
                        timestamp: new Date().toISOString(),
                        email: email,
                        success: true,
                        response: data
                    });
                    return true;
                } else {
                    log('❌ LOGIN FALLITO: ' + data.message, 'phase2-result');
                    updateStatus('phase2', 'error');
                    testResults.login.push({
                        timestamp: new Date().toISOString(),
                        email: email,
                        success: false,
                        error: data.message
                    });
                    return false;
                }
                
            } catch (error) {
                log('💥 ERRORE LOGIN: ' + error.message, 'phase2-result');
                updateStatus('phase2', 'error');
                testResults.login.push({
                    timestamp: new Date().toISOString(),
                    email: email,
                    success: false,
                    error: error.message
                });
                return false;
            }
        }
        
        async function testLoginNewUser() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !password) {
                log('❌ Prima crea un utente nella Fase 1', 'phase2-result');
                return false;
            }
            
            document.getElementById('login-email').value = email;
            document.getElementById('login-password').value = password;
            
            return await testLogin();
        }
        
        async function testLoginInvalid() {
            log('❌ TEST LOGIN CON CREDENZIALI SBAGLIATE', 'phase2-result');
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'nonexist@test.it',
                        password: 'wrongpassword'
                    })
                });
                
                const data = await response.json();
                
                log(`📥 Risposta ricevuta (${response.status}):`, 'phase2-result');
                log(JSON.stringify(data, null, 2), 'phase2-result');
                
                if (!data.success) {
                    log('✅ COMPORTAMENTO CORRETTO: Login rifiutato per credenziali sbagliate', 'phase2-result');
                    return true;
                } else {
                    log('❌ ERRORE: Login riuscito con credenziali sbagliate!', 'phase2-result');
                    return false;
                }
                
            } catch (error) {
                log('💥 ERRORE: ' + error.message, 'phase2-result');
                return false;
            }
        }
        
        // ================================================================
        // TEST UCME
        // ================================================================
        
        async function testSaveUCMe() {
            updateStatus('phase3', 'running');
            log('💾 INIZIO TEST SALVATAGGIO UCME', 'phase3-result');
            
            if (!currentToken) {
                log('❌ Nessun token JWT disponibile. Fai prima il login!', 'phase3-result');
                updateStatus('phase3', 'error');
                return false;
            }
            
            const title = document.getElementById('ucme-title').value;
            const content = document.getElementById('ucme-content').value;
            
            if (!content || content.length < 20) {
                log('❌ Il contenuto deve essere di almeno 20 caratteri', 'phase3-result');
                updateStatus('phase3', 'error');
                return false;
            }
            
            try {
                log(`📤 Invio UCMe con JWT token (length: ${content.length})`, 'phase3-result');
                log(`📤 URL: ${API_BASE}/api/ucme`, 'phase3-result');
                
                const response = await fetch(`${API_BASE}/api/ucme`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        content: content,
                        title: title || null
                    })
                });
                
                const data = await response.json();
                
                log(`📥 Risposta ricevuta (${response.status}):`, 'phase3-result');
                log(JSON.stringify(data, null, 2), 'phase3-result');
                
                if (data.success) {
                    log('✅ UCME SALVATA CON SUCCESSO!', 'phase3-result');
                    log(`📝 UCMe ID: ${data.ucme?.id}`, 'phase3-result');
                    
                    updateStatus('phase3', 'success');
                    testResults.ucme.push({
                        timestamp: new Date().toISOString(),
                        action: 'save',
                        success: true,
                        ucmeId: data.ucme?.id,
                        response: data
                    });
                    return true;
                } else {
                    log('❌ SALVATAGGIO FALLITO: ' + data.message, 'phase3-result');
                    updateStatus('phase3', 'error');
                    testResults.ucme.push({
                        timestamp: new Date().toISOString(),
                        action: 'save',
                        success: false,
                        error: data.message
                    });
                    return false;
                }
                
            } catch (error) {
                log('💥 ERRORE SALVATAGGIO: ' + error.message, 'phase3-result');
                updateStatus('phase3', 'error');
                testResults.ucme.push({
                    timestamp: new Date().toISOString(),
                    action: 'save',
                    success: false,
                    error: error.message
                });
                return false;
            }
        }
        
        async function testLoadUCMes() {
            log('📥 INIZIO TEST CARICAMENTO UCME', 'phase3-result');
            
            if (!currentToken) {
                log('❌ Nessun token JWT disponibile. Fai prima il login!', 'phase3-result');
                return false;
            }
            
            try {
                log('📤 Richiesta UCMe utente con JWT token', 'phase3-result');
                log(`📤 URL: ${API_BASE}/api/ucme`, 'phase3-result');
                
                const response = await fetch(`${API_BASE}/api/ucme`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                log(`📥 Risposta ricevuta (${response.status}):`, 'phase3-result');
                log(JSON.stringify(data, null, 2), 'phase3-result');
                
                if (data.success) {
                    log(`✅ UCMe CARICATE: ${data.ucmes?.length || 0} UCMe trovate`, 'phase3-result');
                    
                    if (data.ucmes && data.ucmes.length > 0) {
                        data.ucmes.forEach((ucme, index) => {
                            log(`📝 UCMe ${index + 1}: ${ucme.content.substring(0, 50)}...`, 'phase3-result');
                        });
                    }
                    
                    testResults.ucme.push({
                        timestamp: new Date().toISOString(),
                        action: 'load',
                        success: true,
                        count: data.ucmes?.length || 0,
                        response: data
                    });
                    return true;
                } else {
                    log('❌ CARICAMENTO FALLITO: ' + data.message, 'phase3-result');
                    testResults.ucme.push({
                        timestamp: new Date().toISOString(),
                        action: 'load',
                        success: false,
                        error: data.message
                    });
                    return false;
                }
                
            } catch (error) {
                log('💥 ERRORE CARICAMENTO: ' + error.message, 'phase3-result');
                testResults.ucme.push({
                    timestamp: new Date().toISOString(),
                    action: 'load',
                    success: false,
                    error: error.message
                });
                return false;
            }
        }
        
        async function testSaveWithoutAuth() {
            log('🚫 TEST SALVATAGGIO SENZA AUTENTICAZIONE', 'phase3-result');
            
            try {
                const response = await fetch(`${API_BASE}/api/ucme`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // Nessun header Authorization
                    },
                    body: JSON.stringify({
                        content: "Tentativo di salvataggio senza token JWT"
                    })
                });
                
                const data = await response.json();
                
                log(`📥 Risposta ricevuta (${response.status}):`, 'phase3-result');
                log(JSON.stringify(data, null, 2), 'phase3-result');
                
                if (!data.success && response.status === 401) {
                    log('✅ COMPORTAMENTO CORRETTO: Accesso negato senza token', 'phase3-result');
                    return true;
                } else {
                    log('❌ ERRORE: Accesso consentito senza autenticazione!', 'phase3-result');
                    return false;
                }
                
            } catch (error) {
                log('💥 ERRORE: ' + error.message, 'phase3-result');
                return false;
            }
        }
        
        // ================================================================
        // TEST CROSS-DEVICE & JWT
        // ================================================================
        
        async function testJWTValidation() {
            updateStatus('phase4', 'running');
            log('🎫 INIZIO TEST VALIDAZIONE JWT', 'phase4-result');
            
            if (!currentToken) {
                log('❌ Nessun token JWT disponibile. Fai prima il login!', 'phase4-result');
                updateStatus('phase4', 'error');
                return false;
            }
            
            try {
                // Test se il token funziona per una richiesta autenticata
                const response = await fetch(`${API_BASE}/api/ucme`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    log('✅ JWT TOKEN VALIDO per richieste API', 'phase4-result');
                    log(`📊 Token length: ${currentToken.length} caratteri`, 'phase4-result');
                    
                    // Prova a decodificare il token (se è formato JWT standard)
                    try {
                        const parts = currentToken.split('.');
                        if (parts.length === 3) {
                            const payload = JSON.parse(atob(parts[1]));
                            log('📝 Payload JWT:', 'phase4-result');
                            log(JSON.stringify(payload, null, 2), 'phase4-result');
                        }
                    } catch (e) {
                        log('⚠️ Token non in formato JWT standard (custom format)', 'phase4-result');
                    }
                    
                    testResults.jwt.push({
                        timestamp: new Date().toISOString(),
                        test: 'validation',
                        success: true,
                        tokenLength: currentToken.length
                    });
                    return true;
                } else {
                    log('❌ JWT TOKEN NON VALIDO', 'phase4-result');
                    testResults.jwt.push({
                        timestamp: new Date().toISOString(),
                        test: 'validation',
                        success: false,
                        error: 'Token rejected by API'
                    });
                    return false;
                }
            } catch (error) {
                log('💥 Errore test JWT: ' + error.message, 'phase4-result');
                return false;
            }
        }
        
        async function testTokenPersistence() {
            log('💾 TEST PERSISTENZA TOKEN', 'phase4-result');
            
            if (!currentToken) {
                log('❌ Nessun token da testare. Fai prima il login!', 'phase4-result');
                return false;
            }
            
            // Simula refresh pagina
            log('🔄 Simulazione refresh pagina...', 'phase4-result');
            
            // Salva token temporaneamente
            const tempToken = currentToken;
            const tempUser = currentUser;
            
            // Simula perdita stato
            currentToken = null;
            currentUser = null;
            
            // Ricarica da localStorage
            loadStoredToken();
            
            if (currentToken === tempToken) {
                log('✅ Token recuperato correttamente da localStorage', 'phase4-result');
                testResults.crossDevice.push({
                    timestamp: new Date().toISOString(),
                    test: 'persistence',
                    success: true
                });
                return true;
            } else {
                log('❌ Token non recuperato correttamente', 'phase4-result');
                testResults.crossDevice.push({
                    timestamp: new Date().toISOString(),
                    test: 'persistence',
                    success: false
                });
                return false;
            }
        }
        
        async function testCrossDevice() {
            log('🔄 INIZIO TEST CROSS-DEVICE COMPLETO', 'phase4-result');
            
            // Test persistenza localStorage
            const storedToken = localStorage.getItem('mental_commons_token');
            const storedUser = localStorage.getItem('mental_commons_user');
            
            log('💾 Test localStorage:', 'phase4-result');
            log(`   Token presente: ${!!storedToken}`, 'phase4-result');
            log(`   User presente: ${!!storedUser}`, 'phase4-result');
            
            if (storedToken && storedUser) {
                log('✅ Dati presenti in localStorage', 'phase4-result');
                
                // Test validità token
                try {
                    const response = await fetch(`${API_BASE}/api/ucme`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${storedToken}`
                        }
                    });
                    
                    if (response.ok) {
                        log('✅ Token valido per richieste cross-device', 'phase4-result');
                        updateStatus('phase4', 'success');
                        
                        testResults.crossDevice.push({
                            timestamp: new Date().toISOString(),
                            test: 'cross_device',
                            success: true,
                            hasStoredToken: !!storedToken,
                            hasStoredUser: !!storedUser,
                            deviceInfo: navigator.userAgent
                        });
                        return true;
                    } else {
                        log('❌ Token non valido', 'phase4-result');
                        updateStatus('phase4', 'error');
                        return false;
                    }
                } catch (error) {
                    log('💥 Errore test token: ' + error.message, 'phase4-result');
                    updateStatus('phase4', 'error');
                    return false;
                }
            } else {
                log('❌ Nessun dato persistente trovato', 'phase4-result');
                updateStatus('phase4', 'error');
                return false;
            }
        }
        
        function clearAllData() {
            clearStoredData();
            log('🗑️ TUTTI I DATI LOCALI PULITI', 'phase4-result');
            
            // Reset status
            ['phase1', 'phase2', 'phase3', 'phase4', 'phase5'].forEach(phase => {
                updateStatus(phase, 'pending');
            });
            
            // Clear all result boxes
            ['phase1-result', 'phase2-result', 'phase3-result', 'phase4-result', 'phase5-result'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    element.textContent = '';
                }
            });
            
            // Reset test results
            testResults = {
                registration: [],
                login: [],
                ucme: [],
                crossDevice: [],
                jwt: []
            };
            
            // Hide summary
            document.getElementById('test-summary').style.display = 'none';
        }
        
        // ================================================================
        // RUN ALL TESTS
        // ================================================================
        
        async function runAllTests() {
            updateStatus('phase5', 'running');
            log('🚀 INIZIO ESECUZIONE AUTOMATICA DI TUTTI I TEST', 'phase5-result');
            
            let allPassed = true;
            let results = {
                registration: false,
                login: false,
                ucme_save: false,
                ucme_load: false,
                jwt: false,
                crossDevice: false
            };
            
            try {
                // 1. Test Registrazione
                log('📝 Step 1: Test Registrazione...', 'phase5-result');
                generateRandomUser();
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.registration = await testRegistration();
                
                // 2. Test Login  
                log('🔑 Step 2: Test Login...', 'phase5-result');
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.login = await testLoginNewUser();
                
                // 3. Test JWT
                log('🎫 Step 3: Test JWT Validation...', 'phase5-result');
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.jwt = await testJWTValidation();
                
                // 4. Test UCMe Save
                log('💾 Step 4: Test UCMe Save...', 'phase5-result');
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.ucme_save = await testSaveUCMe();
                
                // 5. Test UCMe Load
                log('📥 Step 5: Test UCMe Load...', 'phase5-result');
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.ucme_load = await testLoadUCMes();
                
                // 6. Test Cross-Device
                log('🔄 Step 6: Test Cross-Device...', 'phase5-result');
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.crossDevice = await testCrossDevice();
                
                // Calcola risultato finale
                const passedTests = Object.values(results).filter(r => r === true).length;
                const totalTests = Object.keys(results).length;
                const successRate = (passedTests / totalTests * 100).toFixed(1);
                
                log('', 'phase5-result');
                log('📊 ========================================', 'phase5-result');
                log(`📊 RISULTATO FINALE: ${passedTests}/${totalTests} test passati (${successRate}%)`, 'phase5-result');
                log('📊 ========================================', 'phase5-result');
                
                Object.entries(results).forEach(([test, passed]) => {
                    log(`${passed ? '✅' : '❌'} ${test}: ${passed ? 'PASSED' : 'FAILED'}`, 'phase5-result');
                });
                
                if (successRate >= 80) {
                    log('', 'phase5-result');
                    log('🎉 BACKEND SUPABASE FUNZIONA CORRETTAMENTE!', 'phase5-result');
                    log('✅ Login persistente implementato', 'phase5-result');
                    log('✅ UCMe salvate su database PostgreSQL', 'phase5-result');
                    log('✅ JWT tokens funzionanti', 'phase5-result');
                    log('✅ Cross-device sync attivo', 'phase5-result');
                    updateStatus('phase5', 'success');
                } else {
                    log('', 'phase5-result');
                    log('⚠️ ALCUNI TEST FALLITI - Verifica configurazione Supabase', 'phase5-result');
                    updateStatus('phase5', 'error');
                }
                
                // Mostra summary
                showTestSummary(successRate, results);
                
            } catch (error) {
                log('💥 Errore durante esecuzione automatica: ' + error.message, 'phase5-result');
                updateStatus('phase5', 'error');
            }
        }
        
        function showTestSummary(successRate, results) {
            const summaryElement = document.getElementById('test-summary');
            const scoreElement = document.getElementById('final-score');
            const detailsElement = document.getElementById('summary-details');
            
            // Determina colore score
            let scoreClass = 'poor';
            if (successRate >= 90) scoreClass = 'excellent';
            else if (successRate >= 70) scoreClass = 'good';
            else if (successRate >= 50) scoreClass = 'fair';
            
            scoreElement.textContent = successRate + '%';
            scoreElement.className = `score ${scoreClass}`;
            
            const passedTests = Object.values(results).filter(r => r === true).length;
            const totalTests = Object.keys(results).length;
            
            let status = '';
            if (successRate >= 80) {
                status = '🎉 BACKEND COMPLETAMENTE FUNZIONANTE!<br>Il sistema è pronto per la produzione.';
            } else if (successRate >= 50) {
                status = '⚠️ BACKEND PARZIALMENTE FUNZIONANTE<br>Alcuni componenti necessitano correzioni.';
            } else {
                status = '❌ BACKEND NON FUNZIONANTE<br>Rivedere la configurazione Supabase.';
            }
            
            detailsElement.innerHTML = `
                <p>${status}</p>
                <br>
                <p><strong>Test Completati:</strong> ${passedTests}/${totalTests}</p>
                <p><strong>Backend URL:</strong> ${API_BASE}</p>
                <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
            `;
            
            summaryElement.style.display = 'block';
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Commons - Migrazione Utenti a Supabase</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000;
            color: #00ff00;
        }
        .section {
            border: 1px solid #333;
            margin: 20px 0;
            padding: 15px;
            background: #111;
        }
        .log {
            background: #000;
            border: 1px solid #444;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #666;
            padding: 15px 25px;
            margin: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #555;
        }
        button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        .stats {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
        }
        .progress {
            background: #222;
            height: 20px;
            border: 1px solid #666;
            margin: 10px 0;
        }
        .progress-bar {
            background: #00ff00;
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üîÑ Mental Commons - Migrazione Utenti a Supabase</h1>
    <p>Script per migrare gli account esistenti da localStorage a database Supabase centralizzato</p>

    <!-- SEZIONE 1: Analisi Utenti Esistenti -->
    <div class="section">
        <h2>üìä ANALISI UTENTI ESISTENTI</h2>
        <button onclick="analyzeExistingUsers()">üîç Analizza Utenti in localStorage</button>
        <div id="analysis-stats" class="stats"></div>
        <div id="analysis-log" class="log"></div>
    </div>

    <!-- SEZIONE 2: Migrazione -->
    <div class="section">
        <h2>üöÄ MIGRAZIONE A SUPABASE</h2>
        <button id="migrate-btn" onclick="startMigration()" disabled>‚ö° Avvia Migrazione</button>
        <button onclick="testSupabaseConnection()">üîó Test Connessione Supabase</button>
        <div class="progress">
            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
        </div>
        <div id="migration-stats" class="stats"></div>
        <div id="migration-log" class="log"></div>
    </div>

    <!-- SEZIONE 3: Verifica Post-Migrazione -->
    <div class="section">
        <h2>‚úÖ VERIFICA POST-MIGRAZIONE</h2>
        <button onclick="verifyMigration()">üîç Verifica Migrazione Completata</button>
        <button onclick="cleanupLocalStorage()" disabled id="cleanup-btn">üßπ Pulisci localStorage (DOPO verifica)</button>
        <div id="verification-log" class="log"></div>
    </div>

    <script>
        let existingUsers = [];
        let migrationResults = {
            success: 0,
            failed: 0,
            duplicates: 0,
            total: 0
        };

        // Funzioni di logging
        function log(message, type = 'info', targetId = 'analysis-log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(targetId);
            const colorClass = type === 'error' ? 'error' : 
                              type === 'success' ? 'success' : 
                              type === 'warning' ? 'warning' : 'info';
            
            logElement.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            // Log anche in console per debug
            console.log(`[${timestamp}] ${message}`);
        }

        // Update progress bar
        function updateProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
        }

        // Update statistics
        function updateStats(elementId, stats) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <h3>üìä Statistiche:</h3>
                <div>Total utenti: ${stats.total}</div>
                <div>‚úÖ Successi: ${stats.success}</div>
                <div>‚ùå Fallimenti: ${stats.failed}</div>
                <div>üîÑ Duplicati: ${stats.duplicates}</div>
                <div>‚è≥ Rimanenti: ${stats.total - stats.success - stats.failed - stats.duplicates}</div>
            `;
        }

        // API call helper
        async function apiCall(endpoint, data = null, method = 'GET') {
            const baseUrl = window.location.origin;
            const url = `${baseUrl}${endpoint}`;
            
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                const result = await response.json();
                
                return { 
                    success: response.ok, 
                    data: result, 
                    status: response.status,
                    statusText: response.statusText
                };
            } catch (error) {
                return { 
                    success: false, 
                    error: error.message,
                    status: 0,
                    statusText: 'Network Error'
                };
            }
        }

        // Analizza utenti esistenti in localStorage
        function analyzeExistingUsers() {
            document.getElementById('analysis-log').innerHTML = '';
            log('üîç ============================================', 'info');
            log('üîç ANALISI UTENTI ESISTENTI', 'info');
            log('üîç ============================================', 'info');

            // Cerca in tutte le possibili chiavi localStorage
            const possibleKeys = [
                'mc-users',           // Lista utenti principale
                'mc-user',            // Utente corrente
                'mental_commons_users', // Possibile nome alternativo
                'mentalCommons_users'   // Altro possibile nome
            ];

            let allUsers = [];
            let uniqueUsers = new Map();

            log('üìã Scansione localStorage...', 'info');

            possibleKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    log(`‚úÖ Trovato ${key}: ${data.length} caratteri`, 'success');
                    
                    try {
                        if (key === 'mc-user') {
                            // Singolo utente
                            const user = JSON.parse(data);
                            if (user && user.email) {
                                allUsers.push(user);
                                log(`   üë§ Utente singolo: ${user.email}`, 'info');
                            }
                        } else {
                            // Array di utenti
                            const users = JSON.parse(data);
                            if (Array.isArray(users)) {
                                allUsers = allUsers.concat(users);
                                log(`   üë• Array utenti: ${users.length} utenti`, 'info');
                                users.forEach(user => {
                                    if (user && user.email) {
                                        log(`      - ${user.email}`, 'info');
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        log(`‚ùå Errore parsing ${key}: ${e.message}`, 'error');
                    }
                } else {
                    log(`‚ûñ ${key}: non trovato`, 'warning');
                }
            });

            // Deduplica utenti per email
            allUsers.forEach(user => {
                if (user && user.email && !uniqueUsers.has(user.email)) {
                    // Standardizza struttura utente
                    const standardUser = {
                        id: user.id || 'legacy_' + Date.now(),
                        email: user.email,
                        password: user.password || user.accessCode || 'legacy_password',
                        name: user.name || user.email.split('@')[0],
                        createdAt: user.createdAt || new Date().toISOString(),
                        lastLogin: user.lastLogin || new Date().toISOString(),
                        isPortatore: user.isPortatore || false,
                        legacy: true // Flag per identificare utenti migrati
                    };
                    uniqueUsers.set(user.email, standardUser);
                }
            });

            existingUsers = Array.from(uniqueUsers.values());

            log('üìä RISULTATI ANALISI:', 'info');
            log(`   üìÅ Utenti totali trovati: ${allUsers.length}`, 'info');
            log(`   üë§ Utenti unici (deduplicati): ${existingUsers.length}`, 'success');

            if (existingUsers.length === 0) {
                log('‚ö†Ô∏è Nessun utente trovato in localStorage', 'warning');
                log('üí° Possibili cause:', 'info');
                log('   - localStorage gi√† pulito', 'info');
                log('   - Utenti mai creati localmente', 'info');
                log('   - Nomi chiavi diverse da quelle cercate', 'info');
            } else {
                log('üìã Dettaglio utenti da migrare:', 'info');
                existingUsers.forEach((user, index) => {
                    log(`   ${index + 1}. ${user.email} (${user.name})`, 'info');
                    log(`      ID: ${user.id}`, 'info');
                    log(`      Password: ${user.password ? '[PRESENTE]' : '[MANCANTE]'}`, 'info');
                    log(`      Data: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}`, 'info');
                });

                // Abilita pulsante migrazione
                document.getElementById('migrate-btn').disabled = false;
                log('‚úÖ Analisi completata. Pulsante migrazione abilitato.', 'success');
            }

            // Update statistics
            migrationResults.total = existingUsers.length;
            updateStats('analysis-stats', {
                total: existingUsers.length,
                success: 0,
                failed: 0,
                duplicates: 0
            });
        }

        // Test connessione Supabase
        async function testSupabaseConnection() {
            log('üîó Test connessione Supabase...', 'info', 'migration-log');
            
            const result = await apiCall('/api/ping');
            
            if (result.success) {
                log('‚úÖ Supabase connesso correttamente', 'success', 'migration-log');
                log(`   Status: ${result.status}`, 'info', 'migration-log');
                log(`   Response: ${JSON.stringify(result.data)}`, 'info', 'migration-log');
                return true;
            } else {
                log('‚ùå Problema connessione Supabase', 'error', 'migration-log');
                log(`   Status: ${result.status}`, 'error', 'migration-log');
                log(`   Error: ${result.error || result.statusText}`, 'error', 'migration-log');
                return false;
            }
        }

        // Avvia migrazione
        async function startMigration() {
            if (existingUsers.length === 0) {
                log('‚ùå Nessun utente da migrare. Esegui prima l\'analisi.', 'error', 'migration-log');
                return;
            }

            document.getElementById('migration-log').innerHTML = '';
            log('üöÄ ============================================', 'info', 'migration-log');
            log('üöÄ AVVIO MIGRAZIONE UTENTI A SUPABASE', 'info', 'migration-log');
            log('üöÄ ============================================', 'info', 'migration-log');

            // Reset statistiche
            migrationResults = {
                success: 0,
                failed: 0,
                duplicates: 0,
                total: existingUsers.length
            };

            // Test connessione prima di iniziare
            const connectionOk = await testSupabaseConnection();
            if (!connectionOk) {
                log('‚ùå Migrazione interrotta: problemi di connessione', 'error', 'migration-log');
                return;
            }

            // Disabilita pulsante per evitare doppie migrazioni
            document.getElementById('migrate-btn').disabled = true;

            log(`üìä Inizio migrazione di ${existingUsers.length} utenti...`, 'info', 'migration-log');

            for (let i = 0; i < existingUsers.length; i++) {
                const user = existingUsers[i];
                
                log(`\nüë§ Migrazione utente ${i + 1}/${existingUsers.length}: ${user.email}`, 'info', 'migration-log');
                
                // Update progress
                updateProgress(i, existingUsers.length);
                updateStats('migration-stats', migrationResults);

                try {
                    // Tenta registrazione su Supabase
                    const result = await apiCall('/api/register', {
                        email: user.email,
                        password: user.password,
                        name: user.name
                    }, 'POST');

                    if (result.success) {
                        log(`   ‚úÖ ${user.email}: Migrato con successo`, 'success', 'migration-log');
                        migrationResults.success++;
                    } else if (result.status === 409) {
                        log(`   üîÑ ${user.email}: Gi√† esistente in Supabase (OK)`, 'warning', 'migration-log');
                        migrationResults.duplicates++;
                    } else {
                        log(`   ‚ùå ${user.email}: Errore - ${result.data.message || result.statusText}`, 'error', 'migration-log');
                        migrationResults.failed++;
                    }
                } catch (error) {
                    log(`   ‚ùå ${user.email}: Errore critico - ${error.message}`, 'error', 'migration-log');
                    migrationResults.failed++;
                }

                // Pausa breve per non sovraccaricare il server
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Migrazione completata
            updateProgress(existingUsers.length, existingUsers.length);
            updateStats('migration-stats', migrationResults);

            log('\nüéâ ============================================', 'success', 'migration-log');
            log('üéâ MIGRAZIONE COMPLETATA', 'success', 'migration-log');
            log('üéâ ============================================', 'success', 'migration-log');
            log(`üìä Risultati finali:`, 'info', 'migration-log');
            log(`   ‚úÖ Successi: ${migrationResults.success}`, 'success', 'migration-log');
            log(`   üîÑ Duplicati: ${migrationResults.duplicates}`, 'warning', 'migration-log');
            log(`   ‚ùå Fallimenti: ${migrationResults.failed}`, migrationResults.failed > 0 ? 'error' : 'info', 'migration-log');

            if (migrationResults.failed === 0) {
                log('üéØ Migrazione completata con successo!', 'success', 'migration-log');
            } else {
                log('‚ö†Ô∏è Migrazione completata con alcuni errori. Verifica i log.', 'warning', 'migration-log');
            }
        }

        // Verifica migrazione
        async function verifyMigration() {
            document.getElementById('verification-log').innerHTML = '';
            log('üîç ============================================', 'info', 'verification-log');
            log('üîç VERIFICA POST-MIGRAZIONE', 'info', 'verification-log');
            log('üîç ============================================', 'info', 'verification-log');

            if (existingUsers.length === 0) {
                log('‚ö†Ô∏è Nessun utente da verificare. Esegui prima analisi e migrazione.', 'warning', 'verification-log');
                return;
            }

            let verificationResults = {
                verified: 0,
                failed: 0,
                total: existingUsers.length
            };

            log(`üîç Verifica ${existingUsers.length} utenti migrati...`, 'info', 'verification-log');

            for (let i = 0; i < existingUsers.length; i++) {
                const user = existingUsers[i];
                
                log(`\nüîê Test login ${i + 1}/${existingUsers.length}: ${user.email}`, 'info', 'verification-log');

                try {
                    const result = await apiCall('/api/login', {
                        email: user.email,
                        password: user.password
                    }, 'POST');

                    if (result.success) {
                        log(`   ‚úÖ ${user.email}: Login OK - Migrazione verificata`, 'success', 'verification-log');
                        verificationResults.verified++;
                    } else {
                        log(`   ‚ùå ${user.email}: Login fallito - ${result.data.message || result.statusText}`, 'error', 'verification-log');
                        verificationResults.failed++;
                    }
                } catch (error) {
                    log(`   ‚ùå ${user.email}: Errore verifica - ${error.message}`, 'error', 'verification-log');
                    verificationResults.failed++;
                }

                // Pausa breve
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            log('\nüìä RISULTATI VERIFICA:', 'info', 'verification-log');
            log(`   ‚úÖ Verificati: ${verificationResults.verified}`, 'success', 'verification-log');
            log(`   ‚ùå Non verificati: ${verificationResults.failed}`, verificationResults.failed > 0 ? 'error' : 'info', 'verification-log');

            if (verificationResults.failed === 0) {
                log('üéØ Tutti gli utenti verificati con successo!', 'success', 'verification-log');
                log('üßπ √à ora sicuro pulire localStorage', 'success', 'verification-log');
                document.getElementById('cleanup-btn').disabled = false;
            } else {
                log('‚ö†Ô∏è Alcuni utenti non sono stati verificati. NON pulire localStorage ancora.', 'warning', 'verification-log');
            }
        }

        // Pulizia localStorage
        function cleanupLocalStorage() {
            log('üßπ ============================================', 'info', 'verification-log');
            log('üßπ PULIZIA LOCALSTORAGE', 'info', 'verification-log');
            log('üßπ ============================================', 'info', 'verification-log');

            const keysToClean = [
                'mc-users', 'mc-user', 'mc-email', 'mc-onboarded',
                'mentalCommons_ucmes', 'mentalCommons_portatori',
                'mental_commons_users', 'mentalCommons_users'
            ];

            let cleanedKeys = 0;

            keysToClean.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Rimosso: ${key}`, 'success', 'verification-log');
                    cleanedKeys++;
                } else {
                    log(`‚ûñ Non presente: ${key}`, 'info', 'verification-log');
                }
            });

            log(`\n‚úÖ Pulizia completata: ${cleanedKeys} chiavi rimosse`, 'success', 'verification-log');
            log('üéØ localStorage ora pulito, sistema centralizzato su Supabase', 'success', 'verification-log');

            // Disabilita pulsante dopo pulizia
            document.getElementById('cleanup-btn').disabled = true;
        }

        // Auto-start analysis on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                analyzeExistingUsers();
            }, 1000);
        });
    </script>
</body>
</html> 
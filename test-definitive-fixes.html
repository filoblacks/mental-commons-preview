<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Definitivi - Mental Commons</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #000;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        .test-section h2 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #2d5016;
            border: 1px solid #4CAF50;
        }
        .error {
            background: #5d1a1a;
            border: 1px solid #f44336;
        }
        .warning {
            background: #5d4a1a;
            border: 1px solid #FF9800;
        }
        .info {
            background: #1a2d5d;
            border: 1px solid #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        
        /* Test per icona profilo */
        .profile-icon {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 40px !important;
            height: 40px !important;
            box-sizing: border-box !important;
            flex-shrink: 0 !important;
            border: 1px solid #fff;
            border-radius: 6px;
            background: transparent;
            margin: 10px;
        }
        
        .profile-icon svg {
            width: 20px !important;
            height: 20px !important;
            stroke: #fff;
            fill: none;
        }
        
        .profile-icon:hover {
            background: #fff;
        }
        
        .profile-icon:hover svg {
            stroke: #000;
        }
        
        /* Test per sticky stats */
        .test-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-stats div {
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
        }
        
        .test-stats strong {
            color: #4CAF50;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Definitivi - Mental Commons</h1>
    
    <div class="test-section">
        <h2>1. Test Sticky Stats</h2>
        <div class="test-stats">
            <div><strong><span id="ucme-count">‚Äì</span></strong> pensieri accolti</div>
            <div><strong><span id="risposte-count">‚Äì</span></strong> risposte inviate</div>
            <div><strong><span id="portatori-count">‚Äì</span></strong> Portatori attivi</div>
        </div>
        <button onclick="testStickyStats()">Testa Sticky Stats</button>
        <div id="stats-result" class="test-result info">Clicca il pulsante per testare le statistiche</div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Icona Profilo</h2>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="profile-icon" id="test-profile-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div>
                <p>Dimensioni icona: <span id="icon-dimensions">‚Äì</span></p>
                <p>Dimensioni SVG: <span id="svg-dimensions">‚Äì</span></p>
            </div>
        </div>
        <button onclick="testProfileIcon()">Testa Icona Profilo</button>
        <div id="icon-result" class="test-result info">Clicca il pulsante per testare l'icona</div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Payload UCMe</h2>
        <div>
            <label>Contenuto UCMe:</label><br>
            <textarea id="test-content" rows="4" cols="50" style="margin: 10px 0; padding: 10px; background: #222; color: #fff; border: 1px solid #555;">Questo √® un test del payload UCMe completo con tutti i metadati necessari per evitare errori 500.</textarea><br>
            <label>Email:</label><br>
            <input type="email" id="test-email" value="test@example.com" style="margin: 10px 0; padding: 10px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <button onclick="testUCMePayload()">Testa Payload UCMe</button>
        <div id="payload-result" class="test-result info">Clicca il pulsante per testare il payload</div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Esportazione Debug</h2>
        <button onclick="exportDebugData()">Esporta Dati Debug</button>
        <div id="debug-result" class="test-result info">Clicca per esportare i dati di debug</div>
        <textarea id="debug-export" rows="10" cols="80" style="width: 100%; margin: 10px 0; padding: 10px; background: #222; color: #fff; border: 1px solid #555;" readonly placeholder="I dati di debug appariranno qui..."></textarea>
    </div>

    <script>
        // ========================================
        // SIMULAZIONE FUNZIONI PRINCIPALI
        // ========================================
        
        // Simula currentUser
        let currentUser = {
            id: 'test-user-123',
            email: 'test@example.com',
            name: 'Test User'
        };
        
        // Simula ucmeData
        let ucmeData = [
            { id: 1, content: 'Test 1', email: 'user1@test.com' },
            { id: 2, content: 'Test 2', email: 'user2@test.com' }
        ];
        
        // Funzione di logging
        const log = (...args) => console.log(...args);
        const warn = (...args) => console.warn(...args);
        const error = (...args) => console.error(...args);
        
        // Funzione generateUniqueId
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // ========================================
        // FUNZIONE STICKY STATS COPIATA
        // ========================================
        
        function updateStickyStats() {
            log('üìä AGGIORNAMENTO STICKY STATS AFFIDABILE');
            
            const ucmeElement = document.getElementById('ucme-count');
            const risposteElement = document.getElementById('risposte-count');
            const portatoriElement = document.getElementById('portatori-count');
            
            if (!ucmeElement || !risposteElement || !portatoriElement) {
                warn('‚ö†Ô∏è Alcuni elementi contatori mancanti');
                return false;
            }
            
            // Valori base affidabili
            const baseStats = {
                ucme: 23,
                risposte: 15,
                portatori: 8
            };
            
            // Dati reali
            let realStats = { ucme: 0, risposte: 0, portatori: 0 };
            
            try {
                if (typeof ucmeData !== 'undefined' && Array.isArray(ucmeData)) {
                    realStats.ucme = ucmeData.length;
                }
                
                realStats.risposte = Math.floor(realStats.ucme * 0.7);
                realStats.portatori = Math.min(Math.max(Math.floor(realStats.ucme / 3), 3), 12);
                
            } catch (error) {
                warn('‚ö†Ô∏è Errore caricamento dati reali:', error.message);
                realStats = { ucme: 0, risposte: 0, portatori: 0 };
            }
            
            // Statistiche finali
            const finalStats = {
                ucme: baseStats.ucme + realStats.ucme,
                risposte: baseStats.risposte + realStats.risposte,
                portatori: baseStats.portatori + Math.floor(realStats.portatori / 2)
            };
            
            // Aggiorna DOM
            ucmeElement.textContent = finalStats.ucme.toString();
            risposteElement.textContent = finalStats.risposte.toString();
            portatoriElement.textContent = finalStats.portatori.toString();
            
            return finalStats;
        }
        
        // ========================================
        // FUNZIONE COLLECT FORM DATA COPIATA
        // ========================================
        
        function collectFormData(content, email) {
            const backendPayload = {
                // Campi richiesti dal backend
                content: content,
                title: null,
                
                // Metadati utente essenziali
                email: email,
                tone: 'neutro',
                
                // Metadati tecnici per il backend
                userId: currentUser?.id || null,
                timestamp: new Date().toISOString(),
                ucmeId: generateUniqueId(),
                
                // Informazioni di contesto
                userAgent: navigator.userAgent,
                language: navigator.language || 'it',
                platform: navigator.platform || 'unknown',
                screenSize: `${window.innerWidth}x${window.innerHeight}`,
                isMobile: window.innerWidth <= 768,
                
                // Flag di validazione
                portatore: false,
                acceptance: true,
                formValidated: true,
                
                // Versione sistema
                version: '3.0',
                apiVersion: '1.0'
            };
            
            return backendPayload;
        }
        
        // ========================================
        // FUNZIONI DI TEST
        // ========================================
        
        function testStickyStats() {
            const resultDiv = document.getElementById('stats-result');
            resultDiv.innerHTML = 'üîÑ Testando sticky stats...';
            
            try {
                const result = updateStickyStats();
                
                if (result) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `
                        ‚úÖ STICKY STATS FUNZIONANTI<br>
                        UCMe: ${result.ucme}<br>
                        Risposte: ${result.risposte}<br>
                        Portatori: ${result.portatori}<br>
                        Timestamp: ${new Date().toLocaleTimeString()}
                    `;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = '‚ùå Errore nell\'aggiornamento delle statistiche';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `‚ùå Errore: ${error.message}`;
            }
        }
        
        function testProfileIcon() {
            const resultDiv = document.getElementById('icon-result');
            const iconElement = document.getElementById('test-profile-icon');
            const svgElement = iconElement.querySelector('svg');
            
            if (!iconElement || !svgElement) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = '‚ùå Elementi icona non trovati';
                return;
            }
            
            const iconRect = iconElement.getBoundingClientRect();
            const svgRect = svgElement.getBoundingClientRect();
            
            document.getElementById('icon-dimensions').textContent = `${iconRect.width}x${iconRect.height}`;
            document.getElementById('svg-dimensions').textContent = `${svgRect.width}x${svgRect.height}`;
            
            const iconCorrect = iconRect.width === 40 && iconRect.height === 40;
            const svgCorrect = svgRect.width === 20 && svgRect.height === 20;
            
            if (iconCorrect && svgCorrect) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ‚úÖ ICONA PROFILO CORRETTA<br>
                    Icona: ${iconRect.width}x${iconRect.height} (deve essere 40x40)<br>
                    SVG: ${svgRect.width}x${svgRect.height} (deve essere 20x20)<br>
                    Timestamp: ${new Date().toLocaleTimeString()}
                `;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `
                    ‚ùå ICONA PROFILO NON CORRETTA<br>
                    Icona: ${iconRect.width}x${iconRect.height} (deve essere 40x40)<br>
                    SVG: ${svgRect.width}x${svgRect.height} (deve essere 20x20)
                `;
            }
        }
        
        function testUCMePayload() {
            const resultDiv = document.getElementById('payload-result');
            const content = document.getElementById('test-content').value;
            const email = document.getElementById('test-email').value;
            
            if (!content || !email) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = '‚ùå Contenuto e email sono richiesti';
                return;
            }
            
            try {
                const payload = collectFormData(content, email);
                
                // Validazioni
                const validations = {
                    hasContent: !!payload.content,
                    hasEmail: !!payload.email,
                    hasTimestamp: !!payload.timestamp,
                    hasUserId: payload.userId !== undefined,
                    hasUserAgent: !!payload.userAgent,
                    hasVersion: !!payload.version,
                    hasApiVersion: !!payload.apiVersion,
                    fieldsCount: Object.keys(payload).length
                };
                
                const allValid = Object.values(validations).every(v => v === true || typeof v === 'number');
                
                if (allValid) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `
                        ‚úÖ PAYLOAD COMPLETO GENERATO<br>
                        Campi totali: ${validations.fieldsCount}<br>
                        Dimensione JSON: ${JSON.stringify(payload).length} caratteri<br>
                        Content length: ${payload.content.length}<br>
                        User Agent: ${payload.userAgent.substring(0, 50)}...<br>
                        Timestamp: ${payload.timestamp}
                    `;
                } else {
                    resultDiv.className = 'test-result warning';
                    resultDiv.innerHTML = `
                        ‚ö†Ô∏è PAYLOAD PARZIALE<br>
                        Validazioni: ${JSON.stringify(validations, null, 2)}
                    `;
                }
                
                // Salva per debug
                localStorage.setItem('test-payload', JSON.stringify(payload, null, 2));
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `‚ùå Errore nella generazione del payload: ${error.message}`;
            }
        }
        
        function exportDebugData() {
            const resultDiv = document.getElementById('debug-result');
            const exportArea = document.getElementById('debug-export');
            
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    tests: {
                        stickyStats: {
                            tested: true,
                            elements: {
                                ucme: !!document.getElementById('ucme-count'),
                                risposte: !!document.getElementById('risposte-count'),
                                portatori: !!document.getElementById('portatori-count')
                            }
                        },
                        profileIcon: {
                            tested: true,
                            dimensions: {
                                icon: document.getElementById('test-profile-icon')?.getBoundingClientRect(),
                                svg: document.getElementById('test-profile-icon')?.querySelector('svg')?.getBoundingClientRect()
                            }
                        },
                        payload: {
                            tested: true,
                            sample: localStorage.getItem('test-payload') ? JSON.parse(localStorage.getItem('test-payload')) : null
                        }
                    },
                    environment: {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        platform: navigator.platform,
                        screenSize: `${window.innerWidth}x${window.innerHeight}`,
                        currentUser: currentUser,
                        ucmeDataLength: ucmeData?.length || 0
                    },
                    performance: {
                        loadTime: performance.now(),
                        memoryUsage: performance.memory || 'Non disponibile'
                    }
                };
                
                const exportJson = JSON.stringify(debugData, null, 2);
                exportArea.value = exportJson;
                
                // Salva anche in localStorage
                localStorage.setItem('mc-test-debug-export', exportJson);
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    ‚úÖ DEBUG DATA ESPORTATO<br>
                    Dimensione: ${exportJson.length} caratteri<br>
                    Salvato in localStorage come 'mc-test-debug-export'<br>
                    Timestamp: ${new Date().toLocaleTimeString()}
                `;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `‚ùå Errore nell'esportazione: ${error.message}`;
            }
        }
        
        // ========================================
        // INIZIALIZZAZIONE TEST
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Test Mental Commons inizializzato');
            
            // Test automatico delle statistiche
            setTimeout(() => {
                testStickyStats();
            }, 1000);
            
            // Test automatico dell'icona profilo
            setTimeout(() => {
                testProfileIcon();
            }, 1500);
        });
        
    </script>
</body>
</html> 